<div align="center">

<!-- 动态渐变头图 - 东方风格配色 -->
<img src="https://capsule-render.vercel.app/api?type=waving&color=0:B91C1C,50:EF4444,100:FCA5A5&height=220&section=header&text=Touhou%20Isekai%20Izakaya&fontSize=52&fontColor=ffffff&fontAlignY=35&desc=%E6%9D%B1%E6%96%B9%E7%95%B0%E7%95%8C%E9%A3%9F%E5%A0%82&descSize=28&descAlignY=60&animation=twinkling&fontAlign=50" width="100%"/>

<br/>

<!-- 多行动态打字效果 -->
<a href="https://github.com/YoKONCy/touhou-isekai-izakaya">
  <img src="https://readme-typing-svg.demolab.com?font=Noto+Serif+SC&weight=600&size=28&duration=4000&pause=1000&color=B91C1C&center=true&vCenter=true&multiline=true&repeat=false&width=600&height=50&lines=LLM-Driven+Roleplay+Experience;LLM+%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%A7%92%E8%89%B2%E6%89%AE%E6%BC%94%E4%BD%93%E9%AA%8C;Simulation+%E2%9C%A6+RPG+%E2%9C%A6+Management" alt="Title" />
</a>

<br/>

<a href="https://github.com/YoKONCy/touhou-isekai-izakaya">
  <img src="https://readme-typing-svg.demolab.com?font=Noto+Sans+SC&weight=400&size=14&duration=2500&pause=500&color=8E8E93&center=true&vCenter=true&width=700&height=25&lines=Infinite+Narrative+%E2%9C%A6+Deep+Memory+%E2%9C%A6+Touhou+Project+Fan-fiction" alt="Topics" />
</a>

<br/><br/>

<!-- 徽章导航 -->
<a href="./README.md">
  <img src="https://img.shields.io/badge/Status-Beta-red?style=for-the-badge&logo=fire&logoColor=white&labelColor=000000" alt="Beta">
</a>
&nbsp;
<a href="./TECHNICAL_DESIGN.md">
  <img src="https://img.shields.io/badge/Technical-Design-blue?style=for-the-badge&logo=gitbook&logoColor=white&labelColor=000000" alt="Docs">
</a>
&nbsp;
<a href="#-quick-start">
  <img src="https://img.shields.io/badge/Quick-Start-success?style=for-the-badge&logo=rocket&logoColor=white&labelColor=000000" alt="Start">
</a>

<br/><br/>

> **"Welcome to the boundary between fantasy and reality. What can I get for you today?"**

</div>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 📋 Table of Contents

<details open>
<summary><b>Quick Navigation</b></summary>
<br/>

| Section | Description | Link |
|:-------:|:------------|:----:|
| 🎯 | **Overview** - 项目概述与核心特色 | [Jump](#-overview) |
| � | **AI Agent** - 智能体架构解析 | [Jump](#-ai-agent-architecture) |
| �🧠 | **Memory System** - 独特的长记忆机制 | [Jump](#-long-term-memory) |
| 🏗️ | **Architecture** - 系统架构与技术栈 | [Jump](#️-architecture) |
| 🚀 | **Quick Start** - 快速开始指南 | [Jump](#-quick-start) |
| 📅 | **Roadmap** - 开发计划与待办 | [Jump](#-roadmap) |
| ⚠️ | **Disclaimer** - 版权与声明 | [Jump](#-disclaimer) |

</details>

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 🎯 Overview

<div align="center">

<!-- 项目核心亮点卡片 -->
<table>
<tr>
<td align="center" width="160">
<img src="https://img.shields.io/badge/LLM-Driven-B91C1C?style=for-the-badge&labelColor=1c1c1e" alt="LLM"/><br/>
<b>无限叙事</b><br/>
<sub>Infinite Narrative</sub>
</td>
<td align="center" width="160">
<img src="https://img.shields.io/badge/Quartet-Arch-F59E0B?style=for-the-badge&labelColor=1c1c1e" alt="Architecture"/><br/>
<b>四重奏架构</b><br/>
<sub>4-Model Collaboration</sub>
</td>
<td align="center" width="160">
<img src="https://img.shields.io/badge/RAG-Memory-10B981?style=for-the-badge&labelColor=1c1c1e" alt="Memory"/><br/>
<b>长记忆系统</b><br/>
<sub>Scribe & Retrieval</sub>
</td>
<td align="center" width="160">
<img src="https://img.shields.io/badge/Management-Sim-3B82F6?style=for-the-badge&labelColor=1c1c1e" alt="Sim"/><br/>
<b>模拟经营</b><br/>
<sub>Izakaya Management</sub>
</td>
<td align="center" width="160">
<img src="https://img.shields.io/badge/Turn-Based-8B5CF6?style=for-the-badge&labelColor=1c1c1e" alt="Combat"/><br/>
<b>策略战斗</b><br/>
<sub>Danmaku & Persuasion</sub>
</td>
</tr>
</table>

<br/>

**东方异界食堂** 是一款融合了 **LLM (大语言模型)** 叙事、**模拟经营** 与 **RPG 战斗** 的 Web 游戏。
在一次时空乱流的作用下，你穿越来到了幻想乡。初来乍到的你决定通过开店来体验这个奇妙的世界。
美食与力量，你将用何种方式与幻想乡的少女们进行邂逅呢？一切都取决于你自己。

</div>

### ✨ Key Features

- **🎭 LLM 驱动的无限叙事**: 拒绝死板台词，每一位角色都由 AI 驱动。角色会根据性格、好感度以及过往记忆与你交流。
- **🍶 沉浸式居酒屋经营**: 利用程序化生成的瓦片地图系统，自由装修厨房、用餐区。收集食材，研究菜谱，制作出让妖怪和神明都赞不绝口的料理。
- **⚔️ 策略与嘴遁并存的战斗**: 回合制弹幕战与嘴遁系统 (Persuasion) 结合。通过输入文本试图说服对手，AI 将判定你的话语是否能动摇对方的战意。
- **👥 丰富的角色生态**: 收录了百余位东方 Project 经典角色，每人拥有独立的属性、符卡和行为逻辑。

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 🤖 AI Agent Architecture

> 本项目不仅仅是一个简单的 LLM 调用程序，而是一个拥有**感知、记忆、决策、行动**完整回路的 **智能体 (Autonomous Agent)**。

### ⚙️ Core Loop

```mermaid
graph TD
    User[User Input / Game Event] --> Perception[👁️ Perception Layer]
    Perception -->|Context & Intent| Brain[🧠 The Brain (LLM)]
    
    subgraph Memory System
        Brain <-->|Retrieve/Store| STM[Short-term Context]
        Brain <-->|RAG| LTM[(Long-term Memory)]
    end
    
    Brain -->|Reasoning| Decision[⚖️ Decision Layer]
    
    Decision -->|Direct Reply| Output[💬 Dialogue Output]
    Decision -->|Function Call| Action[🛠️ Action Layer]
    
    subgraph World Interaction
        Action -->|Update State| GameState[Game State (Pinia)]
        Action -->|Trigger| Combat[Combat System]
        Action -->|Manage| Economy[Izakaya Management]
    end
    
    GameState -->|Feedback| Perception
    Combat -->|Feedback| Perception
```

#### 1. Perception (感知层)
Agent 不仅接收用户的文本输入，还实时监控**游戏环境状态**（如当前时间、金钱、好感度、任务进度）。所有环境信息会被编码为 System Prompt 的一部分，让 AI "看到" 现在的世界。

#### 2. Brain & Memory (大脑与记忆)
核心 LLM (Storyteller) 结合**短期上下文**（最近的对话）与**长期记忆**（检索到的历史摘要）进行推理。它不仅生成回复，还在思考："玩家现在的意图是什么？" "我应该推进剧情还是闲聊？" "是否需要触发战斗？"

#### 3. Decision & Action (决策与行动)
基于推理结果，Agent 会输出**结构化指令 (XML/JSON)** 而非纯文本。
- **Dialogue**: 生成符合角色性格的回复。
- **State Change**: 修改好感度、扣除金钱、获得物品。
- **System Trigger**: 启动战斗模式、切换场景、发放任务。

这使得 NPC 真正“活”在游戏世界中，而非仅仅是一个聊天机器人。

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 🧠 Long-term Memory

> 本项目采用了一套独特的 **"Scribe-Retrieval"** 记忆机制，旨在解决传统 LLM 游戏“聊久了就忘”的通病，实现真正的长期角色扮演体验。

### ⚙️ Mechanism
 
```mermaid
graph TD
    User[User Input] --> ST[#1 Storyteller]
    ST -->|Dialogue| Scribe[#3 Scribe]
    Scribe -->|Summarize| DB[(IndexedDB Memory)]
    
    subgraph Retrieval Process
        DB -->|Coarse Filter| L1[Level 1: Coarse]
        L1 -->|Refined Check| L2[Level 2: Refined]
        L2 -->|Inject| Context[Context Window]
    end
    
    Context --> ST
```
 
#### 1. The Scribe (记录者)
每一轮对话结束后，独立的 **LLM #3 (Scribe)** 会在后台异步工作，将原始对话**压缩、摘要**为结构化的记忆片段 (Memory Entry)。
 
#### 2. Hybrid Retrieval (混合检索)
- **Level 1 粗筛 (Coarse Mode)**: 基于 **关键词 + 时间权重 + 语义标签** 在本地数据库 (IndexedDB) 中快速查找。零 Token 消耗，速度极快。
- **Level 2 精选 (Refined Mode)**: 将粗筛结果发送给 LLM 进行二次阅读和评分，剔除不相关项，理解深层语义（如“红色的家伙” -> “灵梦”）。
- **Level 3 动态注入**: 最终选出的记忆会被动态插入到 Prompt 中。
 
### 💾 Memory Types

| Type | Icon | Description |
|:---:|:---:|:---|
| **Summary** | 📜 | **剧情摘要**: 自然语言总结，包含谁做了什么、关键情感波动。 |
| **Facility** | 🏗️ | **设施档案**: 记录店铺/房屋改造。当玩家处于相关区域时优先检索。 |
| **Variable** | 🔢 | **状态快照**: 数值层面的“硬事实”（如金钱变动、物品获取）。 |
| **Alliance** | 🤝 | **盟约与情报**: 全局性重要记忆，具有极高检索优先级。 |

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 🏗️ Architecture

### 🛠️ Tech Stack

<div align="center">

<img src="https://img.shields.io/badge/Vue.js-35495E?style=for-the-badge&logo=vue.js&logoColor=4FC08D" />
<img src="https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white" />
<img src="https://img.shields.io/badge/Vite-646CFF?style=for-the-badge&logo=vite&logoColor=white" />
<img src="https://img.shields.io/badge/Pinia-FFE46F?style=for-the-badge&logo=pinia&logoColor=black" />
<br/>
<img src="https://img.shields.io/badge/Tailwind_CSS-38B2AC?style=for-the-badge&logo=tailwind-css&logoColor=white" />
<img src="https://img.shields.io/badge/Dexie.js-323330?style=for-the-badge&logo=javascript&logoColor=F7DF1E" />
<img src="https://img.shields.io/badge/OpenAI-412991?style=for-the-badge&logo=openai&logoColor=white" />

</div>

### 🧩 Quartet Architecture

系统将任务分发给四个独立的 LLM，详见 [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md)。

| ID | Role | Responsibility | Service |
|:---|:---|:---|:---|
| **#1** | **Storyteller** | 扮演 NPC，生成剧情与 XML 触发器 | `gameLoop.ts` |
| **#2** | **Game Master** | 分析剧情，处理逻辑与状态变更 | `logic.ts` |
| **#3** | **Scribe** | 记忆摘要与向量化检索 | `memory.ts` |
| **#4** | **Misc / Tool** | 战斗裁判、瓦片地图生成等杂项 | `MapGenerator.ts` |

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 🚀 Quick Start
 
 ### 前置要求 (Prerequisites)
 - Node.js 16+
 - API Key (支持 OpenAI 格式)
 
 ### 安装步骤 (Installation)
 
 1. **克隆仓库 (Clone the repository)**
    ```bash
    git clone https://github.com/YoKONCy/touhou-isekai-izakaya.git
    cd touhou-isekai-izakaya
    ```
 
 2. **安装依赖 (Install dependencies)**
    ```bash
    npm install
    ```
 
 3. **启动开发服务器 (Start development server)**
    ```bash
    npm run dev
    ```
 
 4. **配置 API (Configure API)**
    - 访问 `http://localhost:14791`
    - 点击 **设置 (⚙️)** 图标
    - 输入您的 API Base URL 和 Key

<br/>

<!-- 动态分隔线 -->
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif" width="100%">

<br/>

## 📅 Roadmap

- [x] **基础架构**: Vue3 + Vite + Pinia + Dexie
- [x] **四重 LLM 架构**: Storyteller + Logic + Scribe + Misc
- [x] **长记忆系统**: Scribe-Retrieval Mechanism
- [x] **地图与经营**: LLM Procedural Generation
- [ ] **角色立绘**: 施工中... (6枚差分/人)
- [ ] **角色像素绘**: 施工中... (用于小游戏)
- [ ] **店铺经营 V2.0**: 自由装修与高级经营
- [ ] **难度配置**: 存档难度分级
- [ ] **2D 探索小游戏**: 俯视角 RPG 模式

<br/>

## ⚠️ Disclaimer

<div align="center">

**非盈利性质 (Non-Profit)** • **AIPR 性质 (AI Roleplay)** • **Fan-fiction (二次创作)**

</div>

- 本项目是 **上海爱丽丝幻乐团 (Team Shanghai Alice)** 原作《东方Project》的二次创作游戏。
- 所有的角色、世界观版权归原作者 **ZUN** 所有。
- 本项目遵循《东方Project》的二次创作通过准则。
- 游戏内素材（立绘、音乐）均为 AI 生成或来源于网络开源/同人授权，仅供学习交流使用。

<br/>

<div align="center">
  <img src="https://capsule-render.vercel.app/api?type=waving&color=0:B91C1C,100:FCA5A5&height=100&section=footer&text=Touhou%20Isekai%20Izakaya&fontSize=24&fontColor=ffffff&animation=twinkling" width="100%"/>
</div>
